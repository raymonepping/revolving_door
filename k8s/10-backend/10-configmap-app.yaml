apiVersion: v1
kind: ConfigMap
metadata:
  name: demo-backend-app
  namespace: default
data:
  app.py: |
    import json
    import os
    import subprocess
    from http.server import BaseHTTPRequestHandler, ThreadingHTTPServer
    from urllib.parse import urlparse

    CREDS_FILE = "/vault/secrets/db.txt"
    DB_HOST = "pg-postgresql.default.svc.cluster.local"
    DB_PORT = "5432"
    DB_NAME = "appdb"

    def parse_kv(text: str) -> dict:
        out = {}
        for line in text.splitlines():
            if "=" in line:
                k, v = line.split("=", 1)
                out[k.strip()] = v.strip()
        return out

    def check_db(username: str, password: str) -> bool:
        env = os.environ.copy()
        env["PGPASSWORD"] = password
        cmd = ["psql", "-h", DB_HOST, "-p", DB_PORT, "-U", username, "-d", DB_NAME, "-tAc", "SELECT 1"]
        p = subprocess.run(cmd, env=env, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, timeout=3)
        return p.returncode == 0

    def door_state():
        if not os.path.exists(CREDS_FILE):
            return {"door": "locked", "reason": "NO_CREDS_FILE"}

        raw = open(CREDS_FILE, "r", encoding="utf-8").read()
        kv = parse_kv(raw)

        user = kv.get("username", "")
        pwd = kv.get("password", "")
        lease_id = kv.get("lease_id", "")
        ttl = kv.get("lease_duration", "")

        if not user or not pwd:
            return {"door": "locked", "reason": "BAD_CREDS_FORMAT"}

        try:
            ok = check_db(user, pwd)
        except Exception as e:
            return {"door": "locked", "reason": "DB_CHECK_ERROR", "error": str(e)}

        if ok:
            return {"door": "opened", "username": user, "lease_id": lease_id, "lease_duration": ttl}

        return {"door": "locked", "reason": "DB_CONNECT_FAILED", "username": user, "lease_id": lease_id, "lease_duration": ttl

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            path = urlparse(self.path).path

            if path == "/healthz":
                payload = {"ok": True}
            else:
                payload = door_state()

            body = (json.dumps(payload) + "\n").encode("utf-8")
            self.send_response(200)
            self.send_header("Content-Type", "application/json; charset=utf-8")
            self.send_header("Content-Length", str(len(body)))
            self.end_headers()
            self.wfile.write(body)

        def log_message(self, *_args, **_kwargs):
            return

    ThreadingHTTPServer(("", 8080), Handler).serve_forever()
